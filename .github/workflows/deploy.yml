name: Build & Deploy Docker to aurigraph.io

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: aurigraph-dlt-corp/aurigraph-website
  SSH_USER: subbu
  SSH_HOST: aurigraph.io
  SSH_PORT: 22
  APP_DIR: ~/aurigraph-website
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: âœ… Checkout code
        uses: actions/checkout@v4

      - name: âœ… Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  deploy:
    needs: build-and-push
    runs-on: self-hosted
    env:
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      DOCKER_TOKEN: ${{ secrets.DOCKER_REGISTRY_TOKEN }}
      GITHUB_ACTOR: ${{ github.actor }}

    steps:
      - name: ðŸ“¤ Configure Git & SSH for Server Access
        env:
          SERVER_SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          git config --global user.email "deployment@aurigraph.io"
          git config --global user.name "Aurigraph Deployment"

          # Write server SSH key (unquoted HEREDOC to allow variable expansion)
          cat > ~/.ssh/id_rsa << SSHKEY
          $SERVER_SSH_KEY
          SSHKEY
          chmod 600 ~/.ssh/id_rsa

          # Verify SSH key was written
          if [ -s ~/.ssh/id_rsa ]; then
            echo "âœ“ SSH key written successfully"
            head -1 ~/.ssh/id_rsa
          else
            echo "âœ— SSH key file is empty!"
            exit 1
          fi

          # Add server to known_hosts
          ssh-keyscan -p "$SSH_PORT" "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: âœ… Checkout code (via HTTPS)
        run: |
          # Initialize git repo and pull latest code
          if [ ! -d .git ]; then
            echo "Initializing fresh repository..."
            git init
            git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/Aurigraph-DLT-Corp/aurigraph-website.git
            git fetch origin "$GITHUB_SHA"
            git reset --hard "$GITHUB_SHA"
          else
            echo "Repository exists, pulling latest..."
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/Aurigraph-DLT-Corp/aurigraph-website.git
            git fetch origin
            git reset --hard "$GITHUB_SHA"
          fi

          echo "âœ“ Repository ready: $(git rev-parse --short HEAD)"

      - name: ðŸš€ Deploy to Production (All-in-One)
        run: |
          # All SSH operations in single step to preserve ssh key context
          ssh -i ~/.ssh/id_rsa -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" bash << 'DEPLOYMENT'
          set -e

          echo "=== DEPLOYMENT STARTED ==="

          # Create app directory
          mkdir -p "$APP_DIR"
          cd "$APP_DIR"

          echo "ðŸ“‹ Copying deployment files..."
          # Files will be copied via scp before this step (see below)

          echo "Authenticating with GitHub Container Registry..."
          echo "$DOCKER_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin

          echo "ðŸ³ Pulling latest Docker image..."
          docker pull "$REGISTRY/$IMAGE_NAME:latest"

          echo "ðŸ›‘ Stopping old containers..."
          docker-compose -f docker-compose.production.yml down 2>/dev/null || true

          echo "ðŸš€ Starting containers..."
          DB_PASSWORD="$DB_PASSWORD" \
          NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
          docker-compose -f docker-compose.production.yml up -d

          echo "â³ Waiting for services to be healthy..."
          sleep 5

          echo "âœ… Verifying containers..."
          docker-compose -f docker-compose.production.yml ps

          echo "=== DEPLOYMENT COMPLETED ==="
          DEPLOYMENT
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          DOCKER_TOKEN: ${{ env.DOCKER_TOKEN }}
          GITHUB_ACTOR: ${{ env.GITHUB_ACTOR }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          NEXTAUTH_SECRET: ${{ env.NEXTAUTH_SECRET }}

      - name: ðŸ“ Copy Files & Deploy (Copy + SSH)
        run: |
          # First, copy files to server
          mkdir -p /tmp/deploy
          cp docker-compose.production.yml nginx.conf .env.production /tmp/deploy/ 2>/dev/null || true
          mkdir -p /tmp/deploy/scripts
          cp scripts/init-db.sql /tmp/deploy/scripts/ 2>/dev/null || true

          # Copy entire deploy directory to server in one scp
          scp -i ~/.ssh/id_rsa -P "$SSH_PORT" -r /tmp/deploy/* "$SSH_USER@$SSH_HOST:$APP_DIR/" || true

      - name: ðŸ§¹ Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_rsa

      - name: ðŸŽ‰ Deployment Success
        if: success()
        run: |
          cat << 'SUCCESS'
          âœ… Docker deployment to https://aurigraph.io successful!

          Services deployed:
            ðŸ˜ PostgreSQL 16 - Database container
            ðŸš€ Next.js App - Application container
            ðŸŒ NGINX Alpine - Reverse proxy container

          Access your site: https://aurigraph.io
          View logs: docker-compose -f ~/aurigraph-website/docker-compose.production.yml logs -f
          SUCCESS

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          cat << 'FAILURE'
          âŒ Deployment failed

          Debug steps:
            ssh subbu@aurigraph.io
            cd ~/aurigraph-website
            docker-compose -f docker-compose.production.yml logs -f
          FAILURE
